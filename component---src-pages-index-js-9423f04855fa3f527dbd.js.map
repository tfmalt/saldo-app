{"version":3,"sources":["webpack:///./src/components/Balance.js","webpack:///./src/pages/index.js"],"names":["Balance","props","_this","_React$Component","call","this","auth","window","success","userId","secret","JSON","parse","localStorage","getItem","state","isAuthenticated","accounts","fetcAccounts","fetchAccounts","bind","assertThisInitialized_default","componentDidMount","console","log","navigate","render","react_default","a","createElement","className","css","list","map","item","key","accountId","itemWrapper","name","available","toFixed","balanceDiv","balance","getAccessToken","_callee","token","then","now","res","json","regenerator_default","wrap","_context","prev","next","Date","date","getTime","expires_in","abrupt","Promise","resolve","access_token","fetch","urls","method","headers","Content-Type","body","stringify","grant_type","client_id","client_secret","sent","ok","Error","status","statusText","hasOwnProperty","warn","setItem","stop","_callee2","_context2","Authorization","setState","setTimeout","React","Component","IndexPage","Layout","headerTitle","SEO","title","keywords","components_Balance"],"mappings":"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","file":"component---src-pages-index-js-9423f04855fa3f527dbd.js","sourcesContent":["import React from 'react'\nimport { navigate } from 'gatsby'\nimport { urls } from '../utils/settings'\nimport css from './Balance.module.scss'\n\nclass Balance extends React.Component {\n  constructor(props) {\n    super(props)\n    let auth =\n      typeof window === 'undefined'\n        ? { success: false, userId: '', secret: '' }\n        : JSON.parse(localStorage.getItem('sd60:authenticate'))\n\n    if (auth === null) {\n      auth = { success: false, userId: '', secret: '' }\n    }\n\n    this.state = {\n      isAuthenticated: auth.success || false,\n      userId: auth.userId || '',\n      secret: auth.secret || '',\n      accounts: [],\n    }\n    this.fetcAccounts = this.fetchAccounts.bind(this)\n\n    // this.fetchAccounts()\n  }\n\n  componentDidMount() {\n    console.log('component did mount. state:', this.state)\n    if (this.state.isAuthenticated === false) {\n      navigate('/authenticate')\n    }\n\n    if (this.state.isAuthenticated) {\n      console.log('FEtching accounts')\n      this.fetchAccounts()\n    }\n  }\n\n  render() {\n    const { accounts } = this.state\n    return (\n      <ul className={css.list}>\n        {accounts.map(item => (\n          <li className={css.item} key={item.accountId}>\n            <div className={css.itemWrapper}>\n              <h3 className={css.name}>{item.name}</h3>\n              <div className={css.available}>\n                <span>kr </span>\n                {item.available.toFixed(2)}\n              </div>\n              <div className={css.balanceDiv}>\n                <span>kr </span>\n                {item.balance.toFixed(2)}\n              </div>\n            </div>\n          </li>\n        ))}\n      </ul>\n    )\n  }\n\n  async getAccessToken() {\n    const token = JSON.parse(localStorage.getItem('sd60:token'))\n    const then = new Date(token.date)\n    const now = new Date()\n\n    if (then.getTime() + (token.expires_in - 300) * 1000 > now.getTime()) {\n      return Promise.resolve(token.access_token)\n    }\n\n    const res = await fetch(urls.token, {\n      method: 'post',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        grant_type: 'client_credentials',\n        client_id: this.state.userId,\n        client_secret: this.state.secret,\n      }),\n    })\n\n    if (!res.ok) {\n      throw new Error(`Invalid response: ${res.status} ${res.statusText}`)\n    }\n\n    const json = await res.json()\n    // lets be a bit paranoid\n    if (\n      !json.hasOwnProperty('access_token') ||\n      !json.hasOwnProperty('expires_in')\n    ) {\n      console.warn(json)\n      throw new Error('Something is not right with the access_token Response.')\n    }\n\n    json.date = new Date()\n    localStorage.setItem('sd60:token', JSON.stringify(json))\n\n    return json.access_token\n  }\n\n  /**\n   * Fetches the accounts from the server.\n   */\n  async fetchAccounts() {\n    const token = await this.getAccessToken()\n    const res = await fetch(urls.balance, {\n      method: 'get',\n      headers: { Authorization: `Bearer ${token}` },\n    })\n\n    console.log('result:', res.status, res.statusText)\n    const json = await res.json()\n    if (!res.ok) {\n      console.warn('error text:', json)\n      return\n    }\n\n    console.log('Getting ready for timeout')\n    this.setState({ accounts: json })\n    setTimeout(\n      function() {\n        console.log('Got timeout')\n        this.fetchAccounts()\n      }.bind(this),\n      60000\n    )\n  }\n}\n\nexport default Balance\n","import React from 'react'\n\nimport Layout from '../components/Layout'\nimport SEO from '../components/SEO'\nimport Balance from '../components/Balance'\n\nconst IndexPage = () => (\n  <Layout headerTitle=\"Saldo - Again\">\n    <SEO title=\"Home\" keywords={[`gatsby`, `open banking`, `react`]} />\n    <Balance />\n  </Layout>\n)\n\nexport default IndexPage\n"],"sourceRoot":""}